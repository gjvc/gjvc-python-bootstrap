#! /bin/bash

# bash ----------------------------------------------------------------------------------------------

set -o errexit -o nounset -o pipefail
[[ -t 0 ]] && [[ -t 1 ]] && stty sane


# location ------------------------------------------------------------------------------------------

readonly _this=$( realpath "${BASH_SOURCE[0]}" )
readonly _basename=$( basename "${_this}" )
readonly _dirname=$( dirname "${_this}" )
readonly _root=$( dirname "${_dirname}" )


# functions -----------------------------------------------------------------------------------------

banner() {
    printf -v line -- '-%0.s' $( seq 1 $(( ${COLUMNS:-99} - 2 )) )
    printf -- "\n\n%s\n" "${line}"
    printf ">>> %s\n" "${@}"
    printf -- "%s\n\n" "${line}"
}

heading() {
    title="${1}"
    printf -v padding -- '-%0.s' $( seq 1 $(( ${COLUMNS:-99} - 3 - ${#title} )) )
    printf -- "\n%s %s\n\n" "${title}" "${padding}"
}


# settings ------------------------------------------------------------------------------------------

version="3.13"


# install -------------------------------------------------------------------------------------------

pip_requirement_d="${_root}/etc/pip-requirement.d/${version}"
roots="${pip_requirement_d}/roots"
versions="${pip_requirement_d}/versions"
pylock_toml="${pip_requirement_d}/pylock.toml"

banner "install"
"${_root}/bin/venv-bin" pipdeptree --freeze |
    awk '/^[^ ]/ { print $1 }' |
    sort |
    tee "${roots}" 1>/dev/null |
    xargs --no-run-if-empty "${_root}/bin/venv-pip3" install


# freeze --------------------------------------------------------------------------------------------

banner "freezing to ${versions}"
"${_root}/bin/venv-bin" pipdeptree --freeze | tee "${versions}" 1>/dev/null

banner "freezing to ${pylock_toml}"
"${_root}/bin/venv-bin" pip3 lock --requirement "${versions}" --output "${pylock_toml}"

heading "diff"
git --no-pager diff "${versions}"
git --no-pager diff "${roots}"

heading "size"
du -sh "${_root}/.venv"
du -sh "${_root}/.pip"

