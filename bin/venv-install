#! /bin/bash

# bash ----------------------------------------------------------------------------------------------

set -o errexit -o nounset -o pipefail
[[ -t 0 ]] || [[ -t 1 ]] && stty sane


# canonical path resolution -------------------------------------------------------------------------

readonly _this=$( realpath "${BASH_SOURCE[0]}" )
readonly _basename=$( basename "${_this}" )
readonly _dirname=$( dirname "${_this}" )
readonly _root=$( dirname "${_dirname}" )


# functions + settings ------------------------------------------------------------------------------

source "${_dirname}/functions"
source "${_dirname}/settings"


# venv ----------------------------------------------------------------------------------------------

if [[ ! -d ${venv_dir} ]]; then
    banner "creating venv ${venv_dir}"
    "${python3}" -m venv "${venv_dir}"
    printf '%s from %s\n' "${venv_dir}" "${python3}"
    if [[ -s "${root}" ]]; then
        requirement="${root}"
    else
        requirement="${bootstrap}"
    fi
fi

if [[ "${1:-}" == "bootstrap" ]]; then
    requirement="${bootstrap}"
elif [[ "${1:-}" == "deptree" ]]; then
    requirement="${deptree}"
elif [[ "${1:-}" == "root" ]]; then
    requirement="${root}"
else
    if [[ -s "${root}" ]] && [[ -s "${deptree}" ]] && [[ "${root}" -nt "${deptree}" ]]; then
        requirement="${root}"
    elif [[ -s "${deptree}" ]]; then
        requirement="${deptree}"
    elif [[ -s "${root}" ]]; then
        requirement="${root}"
    else
        requirement="${bootstrap}"
    fi
fi

banner "installing from ${requirement}"
"${_root}/bin/venv-pip3" install --requirement "${requirement}"

banner "freezing"
"${_root}/bin/venv-freeze"
