#! /bin/bash

# bash ----------------------------------------------------------------------------------------------

set -o errexit -o nounset -o pipefail
[[ -t 0 ]] || [[ -t 1 ]] && stty sane


# location ------------------------------------------------------------------------------------------

readonly _this=$( realpath "${BASH_SOURCE[0]}" )
readonly _basename=$( basename "${_this}" )
readonly _dirname=$( dirname "${_this}" )
readonly _root=$( dirname "${_dirname}" )


# functions + settings ------------------------------------------------------------------------------

source ${_dirname}/functions
source ${_dirname}/settings


# venv ----------------------------------------------------------------------------------------------

if [[ ! -d ${_root}/.venv/ ]]; then
    banner "creating venv ${_root}/.venv"
    "${python3}" -m venv "${_root}/.venv"
    JURIGGED=0 "${_root}/bin/venv-python3" --version
    banner "installing from ${bootstrap}"
    "${_root}/bin/venv-pip3" install --requirement "${bootstrap}"
fi

if [[ -s "${roots}" ]] && [[ -s "${versions}" ]] && [[ "${roots}" -nt "${versions}" ]]; then
    requirement="${roots}"
elif [[ -s "${versions}" ]]; then
    requirement="${versions}"
elif [[ -s "${roots}" ]]; then
    requirement="${roots}"
else
    requirement="${bootstrap}"
fi
banner "installing from ${requirement}"
"${_root}/bin/venv-pip3" install --requirement "${requirement}"


# freeze --------------------------------------------------------------------------------------------

"${_root}/bin/venv-freeze"
"${_root}/bin/venv-freeze"


# install -------------------------------------------------------------------------------------------

banner "re-installing from ${roots}"
"${_root}/bin/venv-bin" pip3 install --requirement "${roots}"


# freeze --------------------------------------------------------------------------------------------

"${_root}/bin/venv-freeze"

# changes -------------------------------------------------------------------------------------------

heading "git diff ${pip_requirement_d}"
git --no-pager diff "${pip_requirement_d}" || true

