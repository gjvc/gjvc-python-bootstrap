#! /bin/bash

# bash ----------------------------------------------------------------------------------------------

set -o errexit -o nounset -o pipefail
[[ -t 0 ]] || [[ -t 1 ]] && stty sane


# canonical path resolution -------------------------------------------------------------------------

readonly _this=$( realpath "${BASH_SOURCE[0]}" )
readonly _basename=$( basename "${_this}" )
readonly _dirname=$( dirname "${_this}" )
readonly _root=$( dirname "${_dirname}" )


# functions + settings ------------------------------------------------------------------------------

source "${_dirname}/functions"
source "${_dirname}/settings"


# freeze --------------------------------------------------------------------------------------------

banner "freezing" "root ${root}" "deptree ${deptree}" "pylock.toml ${pylock_toml}"
"${_root}/bin/venv-bin" pipdeptree --freeze |
    tee "${deptree}" |
    awk '/^[^ ]/ { print $1 }' > "${root}"

"${_root}/bin/venv-bin" pip3 lock --requirement "${deptree}" --output "${pylock_toml}"


# diff ----------------------------------------------------------------------------------------------

banner "git diff ${pip_d}"
git --no-pager diff "${pip_d}" || true

